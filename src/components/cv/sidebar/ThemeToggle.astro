---
/**
 * Theme toggle button styled as a sidebar social link.
 * Swaps between sun/moon icons and Light Mode/Dark Mode text.
 *
 * Layout behavior:
 * - Desktop (md+): Shows icon + text with animated underline
 * - Mobile (<md): Shows icon only (larger touch target)
 * - Print: Hidden entirely
 */
---

<button
  id="theme-toggle"
  type="button"
  class:list={[
    // Layout
    'relative inline-flex items-center gap-2',
    // Typography
    'font-mono text-fluid-xs',
    // Colors & transitions
    'text-muted-foreground hover:text-foreground transition-colors duration-200',
    // Button reset
    'cursor-pointer border-none p-0 text-left',
    // Focus states
    'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring',
    // Print: hide
    'print:hidden',
    // Touch target group for hover states
    'group',
  ]}
  data-print="hide"
  aria-label="Light Mode: Switch to light theme"
>
  {/* Invisible expanded touch target - 44px minimum */}
  <span class="absolute -inset-2 min-w-[44px] min-h-[44px]" aria-hidden="true"></span>

  {/* Icon wrapper - CSS-driven visibility to prevent FOUC */}
  <span class="flex items-center shrink-0">
    {/* Sun icon (shown in dark mode - no data-theme attribute) */}
    <svg
      class="size-[1.125rem] opacity-70 shrink-0 group-hover:opacity-100 lg:size-3 lg:opacity-50 lg:group-hover:opacity-50 block light:hidden"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="1.5"
        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
      ></path>
    </svg>
    {/* Moon icon (shown in light mode - data-theme="light") */}
    <svg
      class="size-[1.125rem] opacity-70 shrink-0 group-hover:opacity-100 lg:size-3 lg:opacity-50 lg:group-hover:opacity-50 hidden light:block"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="1.5"
        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
      ></path>
    </svg>
  </span>

  {/* Desktop text with animated underline - CSS-driven visibility to prevent FOUC */}
  <span class="link-text relative hidden lg:inline">
    {/* "Light Mode" shown in dark mode (clicking switches TO light) */}
    <span class="block light:hidden">Light Mode</span>
    {/* "Dark Mode" shown in light mode (clicking switches TO dark) */}
    <span class="hidden light:block">Dark Mode</span>
    <span
      class="absolute bottom-[-2px] left-0 w-0 h-px bg-[var(--color-foreground)] transition-[width] duration-200 ease-out group-hover:w-full"
      aria-hidden="true"
    ></span>
  </span>
</button>

<script>
  function initThemeToggle() {
    const toggle = document.getElementById('theme-toggle');
    const html = document.documentElement;

    if (!toggle) return;

    // Update aria-label based on current theme
    const updateAriaLabel = () => {
      const isLight = html.getAttribute('data-theme') === 'light';
      toggle.setAttribute(
        'aria-label',
        isLight ? 'Dark Mode: Switch to dark theme' : 'Light Mode: Switch to light theme'
      );
    };

    // Set initial aria-label
    updateAriaLabel();

    // Handle toggle click - CSS handles icon/text visibility via data-theme attribute
    toggle.addEventListener('click', () => {
      const isCurrentlyLight = html.getAttribute('data-theme') === 'light';
      const newTheme = isCurrentlyLight ? 'dark' : 'light';

      localStorage.setItem('theme', newTheme);

      if (newTheme === 'dark') {
        html.removeAttribute('data-theme');
      } else {
        html.setAttribute('data-theme', 'light');
      }

      updateAriaLabel();
    });

    // Also update aria-label if theme changes externally
    const observer = new MutationObserver(updateAriaLabel);
    observer.observe(html, { attributes: true, attributeFilter: ['data-theme'] });
  }

  // Initialize on DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initThemeToggle);
  } else {
    initThemeToggle();
  }

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:page-load', initThemeToggle);
</script>
