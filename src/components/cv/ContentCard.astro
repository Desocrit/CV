---
import TechTag from '../ui/TechTag.astro';
import type { TechTag as TechTagType } from '../../lib/cv-data';

interface Props {
  title: string;
  subtitle?: string;
  tag?: string;
  label?: string;
  technologies?: TechTagType[];
  headline: string;
  bulletPoints: string[];
  supportingData?: string[];
  details?: string;
  cta?: string;
  prompt?: string;
  useTerminal?: boolean;
}

const { title, subtitle, tag, label, technologies = [], headline, bulletPoints, supportingData = [], details, cta, prompt, useTerminal = false } = Astro.props;

// Convert label to SCREAMING_CASE for display
const labelText = label?.toUpperCase().replace(/\s+/g, '_').replace(/'/g, '');

// Escape HTML entities to prevent XSS (apostrophes are safe in text content)
const escapeHtml = (text: string): string => {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
};

// Highlight metrics (numbers, percentages, multipliers) in bullet points
const highlightMetrics = (text: string): string => {
  // Escape HTML first to prevent XSS, then apply highlighting
  const escaped = escapeHtml(text);
  return escaped.replace(
    /(\d+(?:\.\d+)?(?:\s*[xX%])?|\d+(?:,\d{3})*(?:\+)?)/g,
    '<span class="metric-highlight">$1</span>'
  );
};
---

<article class="content-card group">
  <div class="card-grid">
    <!-- Left Column: Title, Subtitle, Tag, Label, Technologies -->
    <div class="card-meta">
      <h3 class="card-title text-fluid-base font-medium tracking-tight text-foreground transition-colors">
        {title}
      </h3>

      {tag && (
        <p class="font-mono text-fluid-2xs text-muted-foreground">
          <span>{tag}</span>
        </p>
      )}

      {label && (
        <p class="label-text font-mono text-fluid-2xs uppercase tracking-widest mt-2">
          <span class="screen-only">{labelText}</span>
          <span class="print-only">{label}</span>
        </p>
      )}

      {subtitle && (
        <p class="text-fluid-2xs text-muted-foreground mt-1">
          {subtitle}
        </p>
      )}

      <!-- Tech stack as diagnostic nodes (dark mode) -->
      {technologies.length > 0 && (
        <div class="tech-tags mt-fluid-xs gap-1.5">
          {technologies.filter(t => !t.name.startsWith('TODO')).slice(0, 4).map((tech) => (
            <TechTag name={tech.name} url={tech.url} tooltip={tech.tooltip} />
          ))}
        </div>
      )}

      <!-- Tech stack as simple list (light mode) -->
      {technologies.length > 0 && (
        <div class="tech-list-light">
          <hr class="tech-divider" />
          <div class="tech-list-text">
            {technologies.filter(t => !t.name.startsWith('TODO')).slice(0, 4).map((tech) => (
              <span class="tech-item">{tech.name}</span>
            ))}
          </div>
        </div>
      )}
    </div>

    <!-- Right Column: Headline, Bullets, Details -->
    <div class="card-content">
      <!-- Headline -->
      <p class="text-fluid-sm text-muted-foreground leading-relaxed font-medium">
        {headline.trim()}
      </p>

      <!-- Bullet Points -->
      <ul class="bullet-list mt-fluid-xs space-y-1 text-fluid-xs">
        {bulletPoints.map((item) => {
          const cleanItem = item.replace(/^["']|["']$/g, '');
          const highlighted = highlightMetrics(cleanItem);
          return (
            <li class="flex items-baseline gap-2 text-muted-foreground">
              <span class="item-separator shrink-0" aria-hidden="true">–</span>
              <span set:html={highlighted} />
            </li>
          );
        })}
      </ul>

      <!-- Supporting Data -->
      {supportingData.length > 0 && (
        <ul class="supporting-list mt-fluid-xs space-y-1 text-fluid-xs">
          {supportingData.map((item) => {
            const cleanItem = item.replace(/^["']|["']$/g, '');
            const highlighted = highlightMetrics(cleanItem);
            return (
              <li class="flex items-baseline gap-2 text-muted-foreground">
                <span class="item-separator shrink-0" aria-hidden="true">–</span>
                <span set:html={highlighted} />
              </li>
            );
          })}
        </ul>
      )}

      <!-- Optional Details Toggle -->
      {details && !useTerminal && (
        <details class="group/details mt-fluid-sm" data-print="hide">
          <summary class="details-toggle inline-flex cursor-pointer list-none items-center gap-0.5 font-mono text-fluid-2xs focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring transition-colors">
            <span class="bracket">[</span>
            <span class="toggle-text light:hidden group-open/details:hidden"> VIEW_DETAILS </span>
            <span class="toggle-text hidden light:hidden group-open/details:inline"> HIDE_DETAILS </span>
            <span class="toggle-text hidden light:inline light:group-open/details:hidden">View details →</span>
            <span class="toggle-text hidden light:group-open/details:inline">← Hide details</span>
            <span class="bracket">]</span>
          </summary>
          <div class="details-content mt-fluid-xs pl-3 border-l-2 text-fluid-xs leading-relaxed whitespace-pre-line">
            {details.trim()}
          </div>
        </details>
      )}

      <!-- Terminal trigger for projects -->
      {prompt && useTerminal && (
        <button
          type="button"
          class="terminal-trigger inline-flex cursor-pointer items-center gap-1 text-fluid-xs font-medium mt-fluid-xs focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring transition-colors"
          data-prompt={prompt.trim()}
          data-print="hide"
          aria-label={`View details for ${title}`}
        >
          <span class="cta-text">{cta ?? 'View details'}</span>
          <span class="cta-arrow" aria-hidden="true">→</span>
        </button>
      )}
    </div>
  </div>
</article>

<style>
  /* Default card accent color - can be overridden by parent */
  .content-card {
    --card-accent: var(--color-accent-purple);
  }

  /* Two-column grid layout matching Experience style */
  .card-grid {
    display: grid;
    grid-template-columns: minmax(135px, 175px) 1fr;
    gap: var(--spacing-fluid-md);
  }

  /* Tech tags: max 2 per row, don't stretch */
  .tech-tags {
    display: grid;
    grid-template-columns: repeat(2, max-content);
    justify-content: start;
    align-items: start;
  }

  /* Right column content */
  .card-content {
    min-width: 0;
  }

  /* Label text - uses card accent color */
  .label-text {
    color: var(--card-accent);
  }

  /* Metric highlighting - uses card accent color */
  .metric-highlight {
    color: var(--card-accent);
  }

  /* Screen/Print visibility utilities */
  .print-only {
    display: none;
  }

  .screen-only {
    display: inline;
  }

  /* Item separator - uses card accent color */
  .item-separator {
    color: var(--card-accent);
  }

  /* Remove default marker */
  summary::-webkit-details-marker {
    display: none;
  }

  summary::marker {
    display: none;
    content: '';
  }

  /* Terminal trigger button - CTA style */
  .terminal-trigger {
    background: none;
    border: none;
    padding: 0;
    color: var(--color-muted-foreground-light);
  }

  .terminal-trigger:hover {
    color: var(--card-accent);
  }

  .terminal-trigger .cta-text {
    color: inherit;
  }

  .terminal-trigger .cta-arrow {
    color: inherit;
    transition: transform 0.15s ease;
  }

  .terminal-trigger:hover .cta-arrow {
    transform: translateX(2px);
  }

  /* Title gets subtle CRT-style glow on card hover - dark mode only */
  .content-card:hover .card-title {
    text-shadow: 0 0 4px color-mix(in srgb, var(--card-accent) 65%, transparent);
  }

  /* Light mode: no glow effect */
  :global([data-theme='light']) .content-card:hover .card-title {
    text-shadow: none;
  }

  /* Details content panel */
  .details-content {
    border-color: var(--card-accent);
    color: var(--color-muted-foreground);
  }

  /* Print tech list - hidden on screen */
  .tech-list-light {
    display: none;
  }

  /* Responsive: Stack on smaller screens */
  @media (max-width: 640px) {
    .card-grid {
      grid-template-columns: 1fr;
      gap: var(--spacing-fluid-xs);
    }

    /* Mobile: Flex layout for card-meta to enable space-between rows */
    .card-meta {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      justify-content: space-between;
      gap: 0;
    }

    .card-meta h3 {
      flex: 0 0 auto;
      order: 1;
    }

    /* Tag element (first p): goes to the right for projects */
    .card-meta > p:first-of-type {
      order: 2;
      margin-left: auto;
      margin-top: 0;
    }

    /* When label exists (history cards): label goes right, tag goes to next row */
    .card-meta .label-text {
      order: 2;
      margin-left: auto;
      margin-top: 0 !important;
    }

    /* Push tag (date) to next row when label exists */
    .card-meta:has(.label-text) > p:not(.label-text) {
      order: 3;
      flex-basis: 100%;
      margin-left: 0;
    }

    /* Tech tags: sm spacing above/below, ensure full width on own row */
    .tech-tags {
      margin-top: var(--spacing-fluid-sm) !important;
      margin-bottom: var(--spacing-fluid-sm);
      flex-basis: 100%;
      order: 10;
    }

  }

  /* Mobile: Light up CTA when card is active */
  @media (max-width: 1023px) {
    .content-card.is-active-card .terminal-trigger {
      color: var(--card-accent);
    }
  }

  /* ===== PRINT STYLES - Professional Content Cards ===== */
  @media print {
    /* Screen/Print visibility toggles */
    .print-only {
      display: inline !important;
    }

    .screen-only {
      display: none !important;
    }

    .content-card {
      padding-top: 0.35rem;
      padding-bottom: 0.35rem;
      border-bottom: none;
    }

    .content-card:last-child {
      border-bottom: none;
    }

    /* Maintain two-column layout in cards */
    .card-grid {
      grid-template-columns: 135px 1fr;
      gap: 0.75rem;
    }

    /* ========================================================================
       ORPHAN/WIDOW CONTROL - LaTeX-quality page break handling
       ======================================================================== */

    /* Card meta (header column) - NEVER break inside */
    .card-meta {
      margin-top: 0;
      break-inside: avoid;
      page-break-inside: avoid;
    }

    .card-meta h3 {
      font-size: 12px;
      font-weight: 600;
      break-after: avoid;
      page-break-after: avoid;
    }

    /* Card meta text (tag, subtitle) */
    .card-meta p {
      font-size: 10px;
    }

    /* Headline - keep with header, avoid orphaning */
    .card-content > p:first-child {
      font-size: 10px;
      line-height: 1.4;
      color: #333;
      break-before: avoid;
      page-break-before: avoid;
      orphans: 3;
      widows: 3;
    }

    /* Bullet list - conditional breaking based on item count
       Short lists (≤4 items): keep together to avoid awkward splits
       Long lists (>4 items): allow breaking to prevent large white gaps */
    .bullet-list {
      padding-left: 1rem;
      margin-top: 0.5rem;
    }

    /* Default: keep bullet lists together */
    .bullet-list:has(li:nth-child(-n+4):last-child) {
      break-inside: avoid;
      page-break-inside: avoid;
    }

    /* Long lists (>4 items): allow page breaks between items */
    .bullet-list:has(li:nth-child(5)) {
      break-inside: auto;
      page-break-inside: auto;
    }

    /* Individual list items - avoid breaking mid-item */
    .bullet-list li {
      display: list-item;
      list-style-type: disc;
      margin: 0.25rem 0;
      font-size: 10px;
      line-height: 1.35;
      color: #4a4a4a;
      break-inside: avoid;
      page-break-inside: avoid;
      orphans: 2;
      widows: 2;
    }

    /* Supporting data list - same styling as bullet list, no extra spacing */
    .supporting-list {
      padding-left: 1rem;
      margin-top: 0;
    }

    .supporting-list li {
      display: list-item;
      list-style-type: disc;
      margin: 0.25rem 0;
      font-size: 10px;
      line-height: 1.35;
      color: #4a4a4a;
      break-inside: avoid;
      page-break-inside: avoid;
      orphans: 2;
      widows: 2;
    }

    /* Label text - professional, not uppercase */
    .label-text {
      color: #4a4a4a;
      text-transform: none;
      font-size: 10px;
      letter-spacing: 0;
      margin-top: 0.15rem;
    }

    /* Metric highlighting - use weight instead of color */
    .metric-highlight {
      color: #1a1a1a;
      font-weight: 700;
    }

    /* Details section - expand for print */
    details {
      display: block;
    }

    summary {
      display: none;
    }

    details > div {
      display: block;
      padding-left: 0;
      margin-top: 0.15rem;
      border: none;
    }

    .details-content {
      color: #4a4a4a;
      border-color: transparent;
      font-size: 10px;
      padding-left: 0;
    }

    /* Hide the dash separator */
    .item-separator {
      display: none;
    }

    /* Tech tags - hide styled tags in print, show simple list */
    .tech-tags {
      display: none;
    }

    .tech-list-light {
      display: block;
      margin-top: 0.5rem;
    }

    .tech-divider {
      border: none;
      border-top: 0.5px solid #c0c0c0;
      margin: 0 0 0.4rem 0;
      margin-right: 2rem;
    }

    .tech-list-text {
      display: grid;
      grid-template-columns: 1fr 1fr;
      justify-items: start;
      gap: 0.15rem;
      font-family: var(--font-sans);
      font-size: 8px;
      font-weight: 400;
      color: #4a4a4a;
      margin: 0;
      padding-right: 2rem;
    }

    .tech-item {
      font-family: var(--font-sans);
    }

    .tech-item:nth-child(even) {
      justify-self: end;
    }

    .tech-item:only-child {
      grid-column: 1 / -1;
      justify-self: center;
    }
  }
</style>

<script>
  // Terminal trigger handler - handles both button clicks and card clicks
  function openTerminal(prompt: string) {
    window.dispatchEvent(
      new CustomEvent('open-rag-terminal', {
        detail: { initialQuery: prompt },
      })
    );
  }

  // Initialize event handlers with proper cleanup for Astro view transitions
  function initContentCardHandlers() {
    const abortController = new AbortController();
    const { signal } = abortController;

    // Attach click handlers to all terminal triggers (button only)
    document.querySelectorAll('.terminal-trigger').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const prompt = (btn as HTMLElement).dataset['prompt'];
        if (prompt) openTerminal(prompt);
      }, { signal });
    });

    // Cleanup on page transition
    document.addEventListener('astro:before-swap', () => {
      abortController.abort();
    }, { once: true });
  }

  // Initialize on page load
  initContentCardHandlers();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:page-load', initContentCardHandlers);
</script>
