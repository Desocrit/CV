---
import TechTag from '../ui/TechTag.astro';
import Heading from '../typography/Heading.astro';
import Text from '../typography/Text.astro';
import Label from '../typography/Label.astro';
import CardGrid from '../layout/CardGrid.astro';
import ScreenOnly from '../layout/ScreenOnly.astro';
import PrintOnly from '../layout/PrintOnly.astro';
import type { TechTag as TechTagType } from '../../lib/cv-data';

type AccentColor = 'green' | 'orange' | 'blue' | 'purple';

type HeadingLevel = 'h2' | 'h3' | 'h4' | 'h5' | 'h6';

interface Props {
  title: string;
  subtitle?: string;
  tag?: string;
  label?: string;
  technologies?: TechTagType[];
  headline: string;
  bulletPoints: string[];
  supportingData?: string[];
  details?: string;
  cta?: string;
  prompt?: string;
  useTerminal?: boolean;
  metaWidth?: 'narrow' | 'default' | 'wide';
  accentColor?: AccentColor;
  /** Hide all bullets except the first on screen (show all in print) */
  hideExtraBullets?: boolean;
  /** Heading level for the card title (default: h3 for proper hierarchy under h2 section headings) */
  headingLevel?: HeadingLevel;
  /** Hide the tag in print mode */
  printHideTag?: boolean;
  /** Stack meta in print: Title on line 1, Label | Date on line 2 (for History/Education) */
  printStackMeta?: boolean;
  /** Limit number of bullets shown in print (undefined = show all) */
  printBulletCount?: number;
  /** Use compact 3-line education format in print */
  printEducationCompact?: boolean;
  /** Education print fields */
  printDegreeTitle?: string;
  printDegree?: string;
  printInstitution?: string;
  printTenure?: string;
  printSpecialism?: string;
  printScore?: string;
}

const { title, subtitle, tag, label, technologies = [], headline, bulletPoints, supportingData = [], details, cta, prompt, useTerminal = false, metaWidth, accentColor = 'purple', hideExtraBullets = false, headingLevel = 'h3', printHideTag = false, printStackMeta = false, printBulletCount, printEducationCompact = false, printDegreeTitle, printDegree, printInstitution, printTenure, printSpecialism, printScore } = Astro.props;

// Classes to hide extra bullets on screen, show all in print
const extraBulletClasses = hideExtraBullets ? '[&:nth-child(n+2)]:hidden print:[&:nth-child(n+2)]:!list-item' : '';

// Map color names to CSS variable classes
const accentColorClass: Record<AccentColor, string> = {
  green: '[--card-accent:var(--color-accent-green)]',
  orange: '[--card-accent:var(--color-accent-orange)]',
  blue: '[--card-accent:var(--color-accent-blue)]',
  purple: '[--card-accent:var(--color-accent-purple)]',
};

// Convert label to SCREAMING_CASE for display
const labelText = label?.toUpperCase().replace(/\s+/g, '_').replace(/'/g, '');

const filteredTechnologies = technologies.filter(t => !t.name.startsWith('TODO')).slice(0, 4);
---

<article class:list={['content-card', 'group', accentColorClass[accentColor], 'py-[0.35rem]', 'print:pt-0 print:pb-0']}>
  <CardGrid metaWidth={metaWidth} class={printEducationCompact ? 'print:!hidden' : ''}>
    <Fragment slot="meta">
        <Heading
          as={headingLevel}
          tiny
          class="card-title transition-[text-shadow] duration-150 ease-out hover:[text-shadow:0_0_4px_var(--card-accent),0_0_12px_color-mix(in_srgb,var(--card-accent)_60%,transparent),0_0_24px_color-mix(in_srgb,var(--card-accent)_30%,transparent)] light:hover:[text-shadow:none] flex-none order-1 sm:flex-initial sm:order-none"
        >
          {title}
        </Heading>

        {tag && (
          <Label as="p" plain class:list={["order-2 ml-auto mt-0 has-[~.label-text]:order-3 has-[~.label-text]:basis-full has-[~.label-text]:ml-0 sm:order-none sm:ml-0 sm:has-[~.label-text]:order-none sm:has-[~.label-text]:basis-auto", (printHideTag || printStackMeta) && "print:hidden"]}>
            <span>{tag}</span>
          </Label>
        )}

        {label && (
          <Label
            as="p"
            accent
            class:list={["label-text mt-0 order-2 ml-auto text-[var(--card-accent)] transition-[text-shadow] duration-150 ease-out hover:[text-shadow:0_0_4px_var(--card-accent),0_0_10px_color-mix(in_srgb,var(--card-accent)_50%,transparent),0_0_20px_color-mix(in_srgb,var(--card-accent)_25%,transparent)] light:hover:[text-shadow:none] print:mt-0.5 sm:mt-2 sm:order-none sm:ml-0", printStackMeta && "print:hidden"]}
          >
            <ScreenOnly as="span">{labelText}</ScreenOnly>
            <PrintOnly as="span">{label}</PrintOnly>
          </Label>
        )}

        {/* Print stacked layout: Label (medium) | Date (light) on second line */}
        {printStackMeta && (label || tag) && (
          <PrintOnly class="basis-full mt-0.5">
            <p class="flex items-baseline gap-1 m-0 print:font-sans">
              {label && <Label as="span" accent class="!text-[var(--color-print-body)] !font-medium print:!font-sans print:mb-0.5">{label}</Label>}
              {label && tag && <Label as="span" class="mx-0.5 print:!font-sans">·</Label>}
              {tag && <Label as="span" class="!font-normal !text-[var(--color-print-muted)] print:!font-sans">{tag}</Label>}
            </p>
          </PrintOnly>
        )}

        {subtitle && (
          <Label
            cardHeader
            class="order-1 ml-2 mt-0 block text-[var(--card-accent)] group-hover:opacity-100 sm:order-none sm:ml-0 sm:mt-1"
          >
            <span class="light:hidden">[ </span>{subtitle}<span class="light:hidden"> ]</span>
          </Label>
        )}

        <!-- Tech stack as diagnostic nodes (screen mode) -->
        {filteredTechnologies.length > 0 ? (
          <ScreenOnly class="!flex flex-wrap gap-1.5 mt-[var(--spacing-fluid-sm)] mb-[var(--spacing-fluid-sm)] basis-full order-[10] sm:mt-fluid-xs sm:mb-0 sm:mr-2 sm:basis-auto sm:order-none">
            {filteredTechnologies.map((tech) => (
              <TechTag name={tech.name} url={tech.url} tooltip={tech.professional_tooltip ?? tech.tooltip} />
            ))}
          </ScreenOnly>
        ) : (
          <ScreenOnly class="mt-[var(--spacing-fluid-sm)] mb-[var(--spacing-fluid-sm)] basis-full order-[10] sm:hidden" aria-hidden="true" />
        )}
    </Fragment>

    <Fragment slot="content">
        <!-- Headline -->
        <Text lead class="print:break-before-avoid print:mt-1">
          {headline.trim()}
        </Text>

        <!-- Bullet Points -->
        <ul class:list={["bullet-list space-y-1 print:space-y-0 mt-[var(--spacing-fluid-xs)] print:mt-1 print:has-[li:nth-child(-n+4):last-child]:break-inside-avoid print:has-[li:nth-child(5)]:break-inside-auto", printBulletCount === 0 && "print:hidden"]}>
          {bulletPoints.map((item, index) => {
            const cleanItem = item.replace(/^["']|["']$/g, '');
            const hiddenInPrint = printBulletCount !== undefined && index >= printBulletCount;
            return (
              <li class:list={["flex items-baseline gap-2 print:block print:leading-tight print:before:content-['–'] print:before:text-[var(--color-print-muted)] print:before:mr-1.5 print:before:relative print:before:top-[2px]", extraBulletClasses, hiddenInPrint && "print:!hidden"]}>
                <span class="shrink-0 text-[var(--card-accent)] print:hidden" aria-hidden="true">–</span>
                <Text as="span" muted>{cleanItem}</Text>
              </li>
            );
          })}
        </ul>

        <!-- Supporting Data -->
        {supportingData.length > 0 && (
          <ul class:list={["supporting-list space-y-1 print:space-y-0 print:mt-0", printBulletCount !== undefined && "print:hidden"]}>
            {supportingData.map((item) => {
              const cleanItem = item.replace(/^["']|["']$/g, '');
              return (
                <li class:list={["flex items-baseline gap-2 print:block print:leading-tight print:before:content-['–'] print:before:text-[var(--color-print-muted)] print:before:mr-1.5 print:before:relative print:before:top-[2px]", extraBulletClasses]}>
                  <span class="shrink-0 text-[var(--card-accent)] print:hidden" aria-hidden="true">–</span>
                  <Text as="span" muted>{cleanItem}</Text>
                </li>
              );
            })}
          </ul>
        )}

        <!-- Optional Details Toggle -->
        {details && !useTerminal && (
          <details class="group/details print:hidden">
            <summary class="inline-flex cursor-pointer list-none items-center gap-0.5 font-mono uppercase text-fluid-2xs text-muted-foreground light:normal-case light:font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring transition-colors [&::-webkit-details-marker]:hidden [&::marker]:hidden [&::marker]:content-['']">
              <span class="bracket">[</span>
              <span class="light:hidden group-open/details:hidden"> VIEW_DETAILS </span>
              <span class="hidden light:hidden group-open/details:inline"> HIDE_DETAILS </span>
              <span class="hidden light:inline light:group-open/details:hidden">View details &#8594;</span>
              <span class="hidden light:group-open/details:inline">&#8592; Hide details</span>
              <span class="bracket">]</span>
            </summary>
            <Text muted class="mt-fluid-xs pl-3 border-l-2 border-[var(--card-accent)] whitespace-pre-line print:pl-0 print:mt-0.5 print:border-none">
              {details.trim()}
            </Text>
          </details>
        )}

        <!-- Terminal trigger for projects -->
        {prompt && useTerminal && (
          <button
            type="button"
            class="terminal-trigger inline-flex cursor-pointer items-center gap-1 text-fluid-xs font-medium text-muted-foreground-light border-none p-0 mt-[var(--spacing-fluid-xs)] hover:text-[var(--card-accent)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring transition-colors group-[.is-active-card]:text-[var(--card-accent)] xl:group-[.is-active-card]:text-muted-foreground-light print:hidden"
            data-prompt={prompt.trim()}
            aria-label={`View details for ${title}`}
          >
            <span>{cta ?? 'View details'}</span>
            <span class="transition-transform duration-150 ease-out group-hover/trigger:translate-x-0.5" aria-hidden="true">&#8594;</span>
          </button>
        )}
    </Fragment>
  </CardGrid>

  {/* Compact education format for print */}
  {printEducationCompact && (
    <PrintOnly class="space-y-0">
      <Heading as="h3" tiny class="m-0">
        {printDegreeTitle}{' '}{printDegree}
      </Heading>
      <p class="m-0 flex items-baseline gap-1 print:font-sans">
        <Label as="span" accent class="!text-[var(--color-print-body)] !font-medium print:!font-sans">{printInstitution}</Label>
        <Label as="span" class="mx-0.5 print:!font-sans">·</Label>
        <Label as="span" class="!font-normal !text-[var(--color-print-muted)] print:!font-sans">{printTenure}</Label>
      </p>
      <p class="m-0 flex items-baseline gap-1 print:font-sans">
        <Label as="span" accent class="!text-[var(--color-print-body)] !font-medium print:!font-sans">{printSpecialism}</Label>
        <Label as="span" class="mx-0.5 print:!font-sans">·</Label>
        <Label as="span" class="!font-normal !text-[var(--color-print-muted)] print:!font-sans">{printScore}</Label>
      </p>
    </PrintOnly>
  )}
</article>

<script>
  // Terminal trigger handler - handles both button clicks and card clicks
  function openTerminal(prompt: string) {
    window.dispatchEvent(
      new CustomEvent('open-rag-terminal', {
        detail: { initialQuery: prompt },
      })
    );
  }

  // Initialize event handlers with proper cleanup for Astro view transitions
  function initContentCardHandlers() {
    const abortController = new AbortController();
    const { signal } = abortController;

    // Attach click handlers to all terminal triggers (button only)
    document.querySelectorAll('.terminal-trigger').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const prompt = (btn as HTMLElement).dataset['prompt'];
        if (prompt) openTerminal(prompt);
      }, { signal });
    });

    // Cleanup on page transition
    document.addEventListener('astro:before-swap', () => {
      abortController.abort();
    }, { once: true });
  }

  // Initialize on page load
  initContentCardHandlers();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:page-load', initContentCardHandlers);
</script>
