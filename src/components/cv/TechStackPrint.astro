---
import type { TechTag } from '../../lib/cv-data';

interface Props {
  technologies: TechTag[];
}

const { technologies } = Astro.props;

// Filter out hidden technologies, then group by their group field, deduplicating by name
const visibleTechnologies = technologies.filter((tech) => !tech.hide_on_sidebar);
const techByGroup = visibleTechnologies.reduce<Record<string, Map<string, TechTag>>>((acc, tech) => {
  const groupMap = acc[tech.group] ?? new Map<string, TechTag>();
  if (!acc[tech.group]) {
    acc[tech.group] = groupMap;
  }
  // Use Map to deduplicate by name
  if (!groupMap.has(tech.name)) {
    groupMap.set(tech.name, tech);
  }
  return acc;
}, {});

// Define the order of groups for consistent display
const groupOrder = [
  'Languages',
  'Databases',
  'Cloud',
  'APIs',
  'Frontend',
  'Design Tools',
  'AI',
  'Backend',
];

// Sort groups by defined order, with unknown groups at the end
const sortedGroups = Object.keys(techByGroup).sort((a, b) => {
  const aIndex = groupOrder.indexOf(a);
  const bIndex = groupOrder.indexOf(b);
  if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
  if (aIndex === -1) return 1;
  if (bIndex === -1) return -1;
  return aIndex - bIndex;
});
---

<section class="tech-stack-print print-only" aria-label="Technical Skills">
  <h2 class="sidebar-section-title">Tech Stack</h2>
  <div class="tech-groups">
    {sortedGroups.map((group) => (
      <div class="tech-group">
        <h3 class="group-title">{group}</h3>
        <p class="tech-list">
          {Array.from(techByGroup[group]?.values() ?? []).map((t) => t.name).join(' Â· ')}
        </p>
      </div>
    ))}
  </div>
</section>

<style>
  .tech-stack-print {
    margin-top: 2.5rem;
  }

  .tech-groups {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .tech-group {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
  }

  .group-title {
    font-family: 'IBM Plex Sans', system-ui, sans-serif;
    font-size: 9px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
    line-height: 1.2;
  }

  .tech-list {
    font-family: 'IBM Plex Mono', 'Consolas', monospace;
    font-size: 10px;
    color: #4a4a4a;
    margin: 0;
    line-height: 1.4;
  }

  @media print {
    .tech-stack-print {
      display: block !important;
    }

    .sidebar-section-title {
      font-family: 'IBM Plex Mono', 'Consolas', monospace;
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #666666 !important;
      border-bottom: 1px solid #4a4a4a;
      padding-bottom: 0.375rem;
      margin-bottom: 0.5rem;
      width: fit-content;
    }
  }
</style>
