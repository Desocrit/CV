---
import type { TechTag } from '../../lib/cv-data';
import PrintOnly from '../layout/PrintOnly.astro';
import Stack from '../layout/Stack.astro';
import Label from '../typography/Label.astro';

interface Props {
  technologies: TechTag[];
}

const { technologies } = Astro.props;

// Filter out hidden technologies, then group by their group field, deduplicating by name
const visibleTechnologies = technologies.filter((tech) => !tech.hide_on_sidebar);
const techByGroup = visibleTechnologies.reduce<Record<string, Map<string, TechTag>>>((acc, tech) => {
  const groupMap = acc[tech.group] ?? new Map<string, TechTag>();
  if (!acc[tech.group]) {
    acc[tech.group] = groupMap;
  }
  // Use Map to deduplicate by name
  if (!groupMap.has(tech.name)) {
    groupMap.set(tech.name, tech);
  }
  return acc;
}, {});

// Define the order of groups for consistent display
const groupOrder = [
  'Languages',
  'Databases',
  'Cloud',
  'APIs',
  'Frontend',
  'Design Tools',
  'AI',
  'Backend',
];

// Sort groups by defined order, with unknown groups at the end
const sortedGroups = Object.keys(techByGroup).sort((a, b) => {
  const aIndex = groupOrder.indexOf(a);
  const bIndex = groupOrder.indexOf(b);
  if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
  if (aIndex === -1) return 1;
  if (bIndex === -1) return -1;
  return aIndex - bIndex;
});
---

<PrintOnly as="section" class="print:mt-10 print:block" aria-label="Technical Skills">
  <Label
    as="h2"
    variant="micro"
    class="print:text-[10px] print:font-medium print:tracking-widest print:text-[#666666] print:border-b print:border-[#4a4a4a] print:pb-1.5 print:mb-2 print:w-fit"
  >
    Tech Stack
  </Label>
  <Stack gap="xs" class="print:mt-2 print:gap-2">
    {sortedGroups.map((group) => (
      <div class="flex flex-col print:gap-px">
        <h3 class="font-sans print:text-[9px] print:font-semibold print:text-[#1a1a1a] print:leading-tight print:m-0">
          {group}
        </h3>
        <p class="font-mono print:text-[10px] print:text-[#4a4a4a] print:leading-snug print:m-0">
          {Array.from(techByGroup[group]?.values() ?? []).map((t) => t.name).join(' Â· ')}
        </p>
      </div>
    ))}
  </Stack>
</PrintOnly>
