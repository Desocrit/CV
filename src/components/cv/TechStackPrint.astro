---
import type { TechTag } from '../../lib/cv-data';
import PrintOnly from '../layout/PrintOnly.astro';
import Stack from '../layout/Stack.astro';
import Label from '../typography/Label.astro';
import Text from '../typography/Text.astro';

interface Props {
  technologies: TechTag[];
}

const { technologies } = Astro.props;

// Filter out hidden technologies, then group by their group field, deduplicating by name
const visibleTechnologies = technologies.filter((tech) => !tech.hide_on_sidebar);
const techByGroup = visibleTechnologies.reduce<Record<string, Map<string, TechTag>>>((acc, tech) => {
  const groupMap = acc[tech.group] ?? new Map<string, TechTag>();
  if (!acc[tech.group]) {
    acc[tech.group] = groupMap;
  }
  // Use Map to deduplicate by name
  if (!groupMap.has(tech.name)) {
    groupMap.set(tech.name, tech);
  }
  return acc;
}, {});

// Define the order of groups for consistent display (consolidated from 7 to 4)
const groupOrder = [
  'Core',
  'Infrastructure',
  'AI & APIs',
  'Frontend',
];

// Explicit item order within each group (balances line lengths)
const itemOrder: Record<string, string[]> = {
  Core: ['TypeScript', 'Java', 'Python', 'Ruby on Rails', '.NET'],
  Infrastructure: ['MongoDB', 'PGSQL', 'SQL Server', 'AWS', 'SQS', 'Docker'],
  'AI & APIs': ['GraphQL', 'gRPC', 'MCP', 'AI SDK', 'mem0', 'RAG'],
  Frontend: ['NextJS', 'Angular', 'Tailwind'],
};

// Sort groups by defined order, with unknown groups at the end
const sortedGroups = Object.keys(techByGroup).sort((a, b) => {
  const aIndex = groupOrder.indexOf(a);
  const bIndex = groupOrder.indexOf(b);
  if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
  if (aIndex === -1) return 1;
  if (bIndex === -1) return -1;
  return aIndex - bIndex;
});

// Chunk array into groups of n
const chunk = <T,>(arr: T[], n: number): T[][] =>
  arr.reduce<T[][]>((acc, item, i) => {
    const chunkIndex = Math.floor(i / n);
    acc[chunkIndex] = acc[chunkIndex] ?? [];
    acc[chunkIndex].push(item);
    return acc;
  }, []);
---

<PrintOnly as="section" aria-label="Technical Skills" block>
  <Label as="h2" variant="section">
    Tech Stack
  </Label>
  <Stack gap="xs" class="print:mt-0 print:gap-2">
    {sortedGroups.map((group) => (
      <Stack gap="none">
        <Label as="h3" variant="tech">
          {group}
        </Label>
        {chunk(
          Array.from(techByGroup[group]?.values() ?? [])
            .map((t) => t.name)
            .sort((a, b) => {
              const order = itemOrder[group] ?? [];
              return (order.indexOf(a) === -1 ? 999 : order.indexOf(a)) - (order.indexOf(b) === -1 ? 999 : order.indexOf(b));
            }),
          3
        ).map((line) => (
          <Text small class="m-0">
            {line.join(' Â· ')}
          </Text>
        ))}
      </Stack>
    ))}
  </Stack>
</PrintOnly>
