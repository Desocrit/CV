---
import type { ImpactNode } from '../../lib/cv-data';

interface Props {
  nodes: ImpactNode[];
}

const { nodes } = Astro.props;

// Category number mapping
const categoryNumbers: Record<string, string> = {
  'Developer Velocity': '01',
  'System Integrity': '02',
  'Talent Density': '03',
  'Global Scale': '04',
};

// Group nodes by header
const groupedNodes = nodes.reduce<Record<string, ImpactNode[]>>((acc, node) => {
  const existing = acc[node.header];
  if (existing) {
    existing.push(node);
  } else {
    acc[node.header] = [node];
  }
  return acc;
}, {});

// Get ordered headers (preserve order from original array)
const orderedHeaders = [...new Set(nodes.map(n => n.header))];
---

<section class="impact-print-section" aria-labelledby="impact-print-heading">
  <h2 id="impact-print-heading" class="impact-print-title">Impact</h2>

  <div class="impact-categories">
    {orderedHeaders.map((header) => {
      const items = groupedNodes[header] ?? [];
      const number = categoryNumbers[header] ?? '00';
      const shortHeader = items[0]?.short_header ?? header.toUpperCase();

      return (
        <article class="category-block">
          {/* Swiss hairline rule - the anchor line */}
          <div class="swiss-rule" role="presentation" />

          {/* Category header - hangs below the rule */}
          <header class="category-header">
            <span class="category-number">{number}</span>
            <span class="category-divider">/</span>
            <span class="category-name">{shortHeader}</span>
          </header>

          {/* Two-column metric rows */}
          <div class="metric-grid">
            {items.map((node) => (
              <div class="metric-row">
                <div class="metric-label">
                  {node.metric_value && (
                    <span class="metric-hook">{node.metric_value}</span>
                  )}{' '}
                  <span class="metric-sublabel">{node.metric_label}</span>
                </div>
                <p class="metric-narrative">{node.long_description || node.description}</p>
              </div>
            ))}
          </div>
        </article>
      );
    })}
  </div>
</section>

<style>
  /* ============================================================================
     SWISS MODERNIST IMPACT GRID
     International Typographic Style for print resume
     Typography: IBM Plex Sans | Grid: 30/70 two-column
     ============================================================================ */

  /* Hidden on screen - print only */
  .impact-print-section {
    display: none;
  }

  @media print {
    .impact-print-section {
      display: block;
      break-inside: avoid;
      page-break-inside: avoid;
      margin-top: 0.75rem;
      margin-bottom: 0.5rem;
    }

    /* ========================================
       SECTION TITLE - matches Section.astro print title
       ======================================== */
    .impact-print-title {
      font-family: 'IBM Plex Sans', system-ui, sans-serif;
      font-size: 11pt;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #1a1a1a;
      margin: 0;
      margin-bottom: 0.5rem;
      padding: 0;
      border: none;
      display: block;
    }

    /* ========================================
       CATEGORIES CONTAINER
       ======================================== */
    .impact-categories {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    /* ========================================
       CATEGORY BLOCK
       ======================================== */
    .category-block {
      width: 100%;
      break-inside: avoid;
    }

    /* ========================================
       SWISS RULE - 0.25pt hairline
       ======================================== */
    .swiss-rule {
        border: none;
        border-top: 0.5px solid #c0c0c0;
        margin: 0 0 0.4rem 0;
        margin-right: 2rem;
    }

    /* ========================================
       CATEGORY HEADER - 8px, matches sidebar labels
       ======================================== */
    .category-header {
      display: flex;
      align-items: baseline;
      gap: 0.15rem;
      margin-top: 0.3rem;
      margin-bottom: 0.35rem;
    }

    .category-number {
      font-family: 'IBM Plex Mono', 'Consolas', monospace;
      font-size: 8px;
      font-weight: 500;
      color: #666666;
      letter-spacing: 0.05em;
    }

    .category-divider {
      font-family: 'IBM Plex Mono', 'Consolas', monospace;
      font-size: 8px;
      font-weight: 500;
      color: #999999;
    }

    .category-name {
      font-family: 'IBM Plex Mono', 'Consolas', monospace;
      font-size: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #666666;
    }

    /* ========================================
       METRIC GRID
       ======================================== */
    .metric-grid {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    /* ========================================
       METRIC ROW - two column grid
       ======================================== */
    .metric-row {
      display: grid;
      grid-template-columns: 25% 1fr;
      gap: 0.5rem;
      align-items: baseline;
      margin-top: 0.25rem;
    }

    /* METRIC LABEL - contains hook + sublabel inline */
    .metric-label {
      white-space: nowrap;
    }

    /* THE HOOK - 13px bold, matches achievement-metric */
    .metric-hook {
      font-family: 'IBM Plex Sans', system-ui, sans-serif;
      font-size: 13px;
      font-weight: 700;
      color: #1a1a1a;
      margin-right: 0.2em;
    }

    /* SUB-LABEL - matches achievement-label print style */
    .metric-sublabel {
      font-family: 'IBM Plex Mono', 'Consolas', monospace;
      font-size: 9px;
      font-weight: 600;
      text-transform: none;
      letter-spacing: 0.01em;
      color: #666666;
    }

    /* NARRATIVE - 9px sans */
    .metric-narrative {
      font-family: 'IBM Plex Sans', system-ui, sans-serif;
      font-size: 9px;
      font-weight: 400;
      color: #4a4a4a;
      margin: 0;
      line-height: 1.4;
    }
  }
</style>
