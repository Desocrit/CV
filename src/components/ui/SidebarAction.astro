---
/**
 * SidebarAction - Unified component for sidebar links, buttons, and toggles
 *
 * Layout behavior:
 * - Mobile dark: Shows icon only in purple accent
 * - Mobile light: Shows icon only in muted gray
 * - Desktop (lg+): Shows icon + longform text with animated underline (both themes)
 * - Print: Hidden entirely
 *
 * Supports dual-state rendering for theme toggle via alt* props and alt-icon slot.
 * When altLongform is provided, switches between states based on light: variant.
 *
 * For buttons, use data-action to specify the action type (e.g., "print", "theme-toggle").
 * Actions are handled via client-side event listeners.
 */
interface Props {
  /** Link URL - if provided, renders as <a> */
  href?: string;
  /** Opens link in new tab */
  external?: boolean;
  /** Action identifier for buttons - handled via client-side event listeners */
  action?: 'print' | 'theme-toggle' | string;
  /** Element ID */
  id?: string;
  /** Full text label shown on desktop (e.g., "LinkedIn", "Light Mode") */
  longform: string;
  /** Alternative longform for light mode (theme toggle) */
  altLongform?: string;
  /** Accessibility label */
  'aria-label': string;
  /** Hide in print (default: true for all sidebar actions) */
  screenOnly?: boolean;
  /** Additional classes */
  class?: string;
}

const {
  href,
  external = false,
  action,
  id,
  longform,
  altLongform,
  'aria-label': ariaLabel,
  screenOnly = false,
  class: className = '',
} = Astro.props;

const isButton = !href;
const hasDualState = !!altLongform;

// Base button/link classes
const baseClasses = [
  // Layout - relative for touch target pseudo-element
  'relative inline-flex items-center gap-2',
  // Typography
  'font-mono text-fluid-sm not-italic',
  // Colors & transitions
  'text-muted-foreground hover:text-foreground transition-colors duration-200',
  // Focus states
  'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring',
  // Button reset (for when it's a button)
  isButton && 'cursor-pointer border-none p-0 text-left',
  // Visibility modifiers
  screenOnly && 'screen-only',
  // Print: hide all sidebar actions
  'print:hidden',
  // Expanded touch target - using before pseudo
  "before:content-[''] before:absolute before:inset-[-0.5rem] before:min-w-[44px] before:min-h-[44px]",
  // Touch target group for hover states
  'group',
].filter(Boolean);

// Icon wrapper classes (single icon mode)
// Dark mode: purple on mobile, muted on desktop
// Light mode: muted with opacity (unchanged from original)
const iconWrapperClasses = [
  'flex items-center shrink-0',
  '[&>svg]:block [&>svg]:shrink-0 [&>svg]:size-[1.125rem]',
  // Dark mode: purple accent
  'text-accent-purple',
  // Light mode: muted gray with opacity (original behavior)
  'light:text-muted-foreground light:[&>svg]:opacity-70',
  // Desktop (lg+): smaller icons, muted color for both themes
  'lg:text-muted-foreground lg:[&>svg]:size-3 lg:[&>svg]:opacity-50',
].join(' ');

// Primary icon classes (for dual-state: shown in dark mode only)
const primaryIconClasses = [
  'block shrink-0 text-accent-purple [&>svg]:size-[1.125rem]',
  // Desktop: smaller, muted
  'lg:text-muted-foreground lg:[&>svg]:size-3 lg:[&>svg]:opacity-50',
  // Light mode: hidden (alt icon shows instead)
  'light:hidden',
].join(' ');

// Alt icon classes (for dual-state: shown in light mode only)
const altIconClasses = [
  'hidden shrink-0',
  // Light mode mobile: show, muted gray with opacity
  'light:block light:text-muted-foreground light:[&>svg]:size-[1.125rem] light:[&>svg]:opacity-70',
  // Desktop light: smaller, muted
  'lg:light:[&>svg]:size-3 lg:light:[&>svg]:opacity-50',
].join(' ');

// Link text classes - with animated underline on hover
const linkTextClasses = [
  'relative hidden',
  // Desktop: show text
  'lg:inline',
  // Animated underline (desktop only)
  "after:content-[''] after:absolute after:bottom-[-2px] after:left-0 after:w-0 after:h-px after:bg-foreground after:transition-[width] after:duration-200 after:ease-out",
  'group-hover:after:w-full',
  // Print: disable underline animation
  'print:after:hidden print:after:content-none',
].join(' ');

// Element type
const Element = isButton ? 'button' : 'a';
---

<Element
  href={!isButton ? href : undefined}
  type={isButton ? 'button' : undefined}
  id={id}
  class:list={[baseClasses, className]}
  target={external ? '_blank' : undefined}
  rel={external ? 'noopener noreferrer' : undefined}
  data-action={action}
  aria-label={ariaLabel}
>
  {/* Icon section */}
  {hasDualState ? (
    <span class="flex items-center shrink-0">
      {/* Primary icon (shown in dark mode on desktop) */}
      <span class={primaryIconClasses}>
        <slot name="icon" />
      </span>
      {/* Alt icon (shown in light mode) */}
      <span class={altIconClasses}>
        <slot name="alt-icon" />
      </span>
    </span>
  ) : (
    <span class={iconWrapperClasses}>
      <slot name="icon" />
    </span>
  )}

  {/* Text section */}
  <span class={linkTextClasses}>
    {hasDualState ? (
      <>
        <span class="block light:hidden">{longform}</span>
        <span class="hidden light:block">{altLongform}</span>
      </>
    ) : (
      longform
    )}
  </span>
</Element>

<script>
  /**
   * Handle SidebarAction button clicks via data-action attribute.
   * Supported actions: "print"
   * Note: "theme-toggle" is handled separately in Nav.astro
   */
  function initSidebarActions() {
    document.querySelectorAll<HTMLButtonElement>('button[data-action]').forEach((button) => {
      const action = button.dataset['action'];

      if (action === 'print') {
        button.addEventListener('click', () => {
          window.print();
        });
      }
    });
  }

  // Initialize on DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebarActions);
  } else {
    initSidebarActions();
  }

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:page-load', initSidebarActions);
</script>
