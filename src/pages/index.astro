---
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/cv/Sidebar.astro';
import Section from '../components/ui/Section.astro';
import ContentCard from '../components/cv/ContentCard.astro';
import ImpactGrid from '../components/cv/ImpactGrid.astro';
import ImpactGridPrint from '../components/cv/ImpactGridPrint.astro';
import { cvData } from '../lib/cv-data';

const impactNodes = cvData.impact_nodes;

const socialLinks = [
  { platform: 'LinkedIn', url: cvData.linkedin },
  { platform: 'GitHub', url: cvData.github },
];

const workExperiences = cvData.work_history.map((exp) => {
  const tenureParts = exp.tenure.split(' — ');
  return {
    company: exp.company,
    role: exp.role,
    startDate: tenureParts[0] ?? exp.tenure,
    endDate: tenureParts[1] || undefined,
    location: cvData.location,
  };
});

const educationData = cvData.education.map((edu) => ({
  institution: edu.institution,
  degree: edu.degree_title ?? edu.degree,
  field: edu.specialism ?? edu.degree,
  startDate: String(edu.year),
  endDate: String(edu.year),
}));
---

<Layout
  title={`${cvData.name} - CV`}
  description={`Professional CV for ${cvData.name}, ${cvData.role} based in ${cvData.location}.`}
  name={cvData.name}
  jobTitle={cvData.role}
  email={cvData.email}
  location={cvData.location}
  website={cvData.website}
  socialLinks={socialLinks}
  workExperiences={workExperiences}
  education={educationData}
  knowsAbout={cvData.meta.keywords}
  summary={cvData.summary}
>
  <div class="cv-layout">
    <Sidebar
      name={cvData.name}
      role={cvData.role}
      email={cvData.email}
      phone={cvData.phone}
      location={cvData.location}
      linkedin={cvData.linkedin}
      github={cvData.github}
      profile={cvData.summary}
      achievements={cvData.outlier_achievements}
      education={{
        degree: cvData.education[0]?.degree ?? '',
        degree_title: cvData.education[0]?.degree_title ?? '',
        score_short: cvData.education[0]?.score_short ?? '',
        specialism: cvData.education[0]?.specialism ?? '',
        institution: cvData.education[0]?.institution ?? '',
        year: cvData.education[0]?.year ?? 0,
      }}
    />

    <div class="main-column">
      <div class="main-content">
        <div class="projects-section">
          <Section title="Projects" id="projects">
            <div class="content-list">
              {cvData.projects.slice(0, 4).map((project) => (
                <div class="content-item border-t border-border pt-fluid-sm pb-fluid-sm first:border-t-0 first:pt-0">
                  <ContentCard
                    title={project.project_title}
                    tag={project.subtitle}
                    technologies={project.stack_and_tools}
                    headline={project.the_premise}
                    bulletPoints={project.impact_and_acclaim}
                    prompt={project.prompt}
                    useTerminal={true}
                  />
                </div>
              ))}
            </div>
          </Section>
        </div>

        <div class="impact-screen-only">
          <ImpactGrid nodes={impactNodes} />
        </div>
        <ImpactGridPrint nodes={impactNodes} />

        <div class="history-section">
          <Section title="History" id="history">
            <div class="content-list">
              {cvData.work_history.map((job) => (
                <div class="content-item border-t border-border pt-fluid-sm pb-fluid-sm first:border-t-0 first:pt-0">
                  <ContentCard
                    title={job.role}
                    tag={job.tenure}
                    label={job.company}
                    technologies={job.tech_stack}
                    headline={job.summary}
                    bulletPoints={job.impact}
                  />
                </div>
              ))}
            </div>
          </Section>
        </div>

        <div class="education-section">
          <Section title="Education" id="education">
            <div class="content-list">
              <div class="content-item">
                <ContentCard
                  title={cvData.education[0]?.degree ?? 'Computer Science'}
                  tag={cvData.education[0]?.tenure ?? String(cvData.education[0]?.year)}
                  label={cvData.education[0]?.institution}
                  technologies={[]}
                  headline={`${cvData.education[0]?.score_long} from the University of Southampton.`}
                  bulletPoints={[
                    `Masters of Engineering in ${cvData.education[0]?.specialism}`,
                    cvData.education[0]?.notable ?? '',
                  ].filter(Boolean)}
                />
              </div>
            </div>
          </Section>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .cv-layout {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 0;
    height: 100vh;
    overflow: hidden;
  }

  .main-column {
    min-width: 0;
    overflow-y: auto;
  }

  .main-content {
    max-width: 80ch;
    padding: var(--spacing-fluid-lg);
  }

  @media (min-width: 1200px) {
    .main-content {
      max-width: 100ch;
    }
  }

  @media (max-width: 1023px) {
    .cv-layout {
      grid-template-columns: 1fr;
      gap: 0;
      height: auto;
      overflow: visible;
    }

    .main-column {
      overflow-y: visible;
    }

    .main-content {
      padding: var(--spacing-fluid-md);
      padding-top: 0;
    }
  }

  /* Projects section color cycling: green → purple → blue → green */
  .projects-section .content-item:nth-child(1) :global(.content-card) { --card-accent: var(--color-accent-green); }
  .projects-section .content-item:nth-child(2) :global(.content-card) { --card-accent: var(--color-accent-purple); }
  .projects-section .content-item:nth-child(3) :global(.content-card) { --card-accent: var(--color-accent-blue); }
  .projects-section .content-item:nth-child(4) :global(.content-card) { --card-accent: var(--color-accent-green); }

  /* History section color cycling: green → purple → blue */
  .history-section .content-item:nth-child(1) :global(.content-card) { --card-accent: var(--color-accent-green); }
  .history-section .content-item:nth-child(2) :global(.content-card) { --card-accent: var(--color-accent-purple); }
  .history-section .content-item:nth-child(3) :global(.content-card) { --card-accent: var(--color-accent-blue); }

  /* Education section: mobile-only, always green */
  .education-section {
    display: none;
  }

  .education-section :global(.content-card) {
    --card-accent: var(--color-accent-green);
  }

  .education-section :global(.section-with-label) {
    --section-accent: var(--color-accent-green);
  }

  @media (max-width: 1023px) {
    .education-section {
      display: block;
    }
  }

  /* Section title hover effects - lg desktop only (mobile/md use scroll-based color) */
  @media (min-width: 1200px) {
    /* Projects */
    .projects-section:has(.content-item:nth-child(1):hover) :global(.section-title) {
      color: var(--color-accent-green);
      transition: color 0.15s ease;
    }
    .projects-section:has(.content-item:nth-child(2):hover) :global(.section-title) {
      color: var(--color-accent-purple);
      transition: color 0.15s ease;
    }
    .projects-section:has(.content-item:nth-child(3):hover) :global(.section-title) {
      color: var(--color-accent-blue);
      transition: color 0.15s ease;
    }
    .projects-section:has(.content-item:nth-child(4):hover) :global(.section-title) {
      color: var(--color-accent-green);
      transition: color 0.15s ease;
    }

    /* History */
    .history-section:has(.content-item:nth-child(1):hover) :global(.section-title) {
      color: var(--color-accent-green);
      transition: color 0.15s ease;
    }
    .history-section:has(.content-item:nth-child(2):hover) :global(.section-title) {
      color: var(--color-accent-purple);
      transition: color 0.15s ease;
    }
    .history-section:has(.content-item:nth-child(3):hover) :global(.section-title) {
      color: var(--color-accent-blue);
      transition: color 0.15s ease;
    }
  }

  @media print {
    .cv-layout {
      display: grid;
      grid-template-columns: 190px 1fr;
      gap: 1rem;
      height: auto;
      overflow: visible;
    }

    .main-column {
      margin-top: 0;
      overflow: visible;
    }

    .main-content {
      max-width: none;
      padding: 0;
    }

    .content-item {
      border-top: none !important;
      padding-top: 0.1rem !important;
      padding-bottom: 0.1rem !important;
    }

    .content-list {
      display: flex;
      flex-direction: column;
      gap: 0.05rem;
    }

    /* Hide main column education section for print - education appears in sidebar only */
    .education-section {
      display: none !important;
    }

    /* Hide screen-only ImpactGrid in print - use ImpactGridPrint instead */
    .impact-screen-only {
      display: none !important;
    }

    /* Section spacing - match sidebar 2.5rem breathing room */
    .impact-print-section {
      margin-top: 2.5rem;
    }

    .history-section {
      margin-top: 2.5rem;
    }
  }
</style>
