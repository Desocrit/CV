---
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/cv/Sidebar.astro';
import Section from '../components/ui/Section.astro';
import ContentCard from '../components/cv/ContentCard.astro';
import LeadershipGrid from '../components/cv/LeadershipGrid.astro';
import { cvData } from '../lib/cv-data';

// Transform skills data for Sidebar component
const skillCategories = [
  {
    name: 'technical_specialties',
    displayName: 'Technical Specialties',
    skills: cvData.skills.technical_specialties,
  },
  {
    name: 'organizational_leverage',
    displayName: 'Organizational Leverage',
    skills: cvData.skills.organizational_leverage,
  },
  {
    name: 'emerging_frontier',
    displayName: 'Emerging Frontier',
    skills: cvData.skills.emerging_frontier,
  },
];

// Pass impact_nodes directly to component
const impactNodes = cvData.impact_nodes;

// Transform data for Layout JSON-LD
const socialLinks = [
  { platform: 'LinkedIn', url: cvData.linkedin },
  { platform: 'GitHub', url: cvData.github },
];

const workExperiences = cvData.work_history.map((exp) => {
  const tenureParts = exp.tenure.split(' â€” ');
  return {
    company: exp.company,
    role: exp.role,
    startDate: tenureParts[0] ?? exp.tenure,
    endDate: tenureParts[1] || undefined,
    location: cvData.location,
  };
});

const educationData = cvData.education.map((edu) => ({
  institution: edu.institution,
  degree: edu.degree,
  field: '',
  startDate: String(edu.year),
  endDate: String(edu.year),
}));
---

<Layout
  title={`${cvData.name} - CV`}
  description={`Professional CV for ${cvData.name}, ${cvData.role} based in ${cvData.location}.`}
  name={cvData.name}
  jobTitle={cvData.role}
  email={cvData.email}
  location={cvData.location}
  socialLinks={socialLinks}
  workExperiences={workExperiences}
  education={educationData}
  knowsAbout={cvData.meta.keywords}
>
  <!-- Two-column asymmetric layout -->
  <div class="cv-layout">
    <!-- Left Column: Sticky Sidebar (33%) -->
    <Sidebar
      name={cvData.name}
      role={cvData.role}
      email={cvData.email}
      location={cvData.location}
      linkedin={cvData.linkedin}
      github={cvData.github}
      website={cvData.website}
      achievements={cvData.outlier_achievements}
      education={{
        degree: cvData.education[0]?.degree ?? '',
        degree_title: cvData.education[0]?.degree_title ?? '',
        score_short: cvData.education[0]?.score_short ?? '',
        specialism: cvData.education[0]?.specialism ?? '',
        institution: cvData.education[0]?.institution ?? '',
        year: cvData.education[0]?.year ?? 0,
      }}
      skillCategories={skillCategories}
    />

    <!-- Right Column: Scrolling Main Content (66%) -->
    <div class="main-column">
      <!-- Profile -->
      <Section title="Profile" id="profile">
        <p class="text-fluid-sm text-muted-foreground leading-relaxed">
          {cvData.summary}
        </p>
      </Section>

      <!-- Projects -->
      <Section title="Projects" id="projects">
        <div class="content-list">
          {cvData.projects.slice(0, 4).map((project, index) => (
            <div class="border-t border-border pt-fluid-sm pb-fluid-sm first:border-t-0 first:pt-0" data-print={index >= 2 ? 'hide' : undefined}>
              <ContentCard
                title={project.project_title}
                tag={project.subtitle}
                technologies={project.stack_and_tools}
                headline={project.the_premise}
                bulletPoints={project.impact_and_acclaim}
                details={project.technical_meat}
              />
            </div>
          ))}
        </div>
      </Section>

      <!-- Experience -->
      <Section title="History" id="experience">
        <div class="content-list">
          {cvData.work_history.map((job) => (
            <div class="border-t border-border pt-fluid-sm pb-fluid-sm first:border-t-0 first:pt-0">
              <ContentCard
                title={job.role}
                tag={job.tenure}
                label={job.company}
                technologies={job.tech_stack}
                headline={job.summary}
                bulletPoints={job.impact}
              />
            </div>
          ))}
        </div>
      </Section>

      <!-- Impact -->
      <LeadershipGrid nodes={impactNodes} />
    </div>
  </div>
</Layout>

<style>
  /* Two-column asymmetric layout */
  .cv-layout {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 0;
    height: 100vh;
    overflow: hidden;
  }

  /* Main content column */
  .main-column {
    min-width: 0; /* Prevent grid blowout */
    overflow-y: auto;
    padding: var(--spacing-fluid-lg) var(--spacing-fluid-lg) var(--spacing-fluid-xl) 0;
  }

  /* Responsive: Stack on smaller screens (normal scrolling) */
  @media (max-width: 1024px) {
    .cv-layout {
      grid-template-columns: 1fr;
      gap: 0;
      height: auto;
      overflow: visible;
    }

    .main-column {
      overflow-y: visible;
      padding: var(--spacing-fluid-md);
    }
  }

  /* Print: Professional two-column layout */
  @media print {
    .cv-layout {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 1.5rem;
      height: auto;
      overflow: visible;
    }

    .main-column {
      margin-top: 0;
      overflow: visible;
      padding: 0;
    }
  }
</style>
